---
title: "Oregon Child Abuse Prevalence Study"
subtitle: "Synthesized Data"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(reactable)
library(tidyverse)
library(colorblindr)
library(plotly)
library(here)
library(rio)
library(dplyr)
library(likert)
library(scales)
#theme_set(theme_minimal(legend.position= c(0.8, 0.2)))

raw <- import(here("data", "feb17_an.csv")) 


long <- raw %>% 
  pivot_longer(
    cols = c("Q3_1":"Q3_7", "Q3_8":"Q3_10"),
    names_to = "toss",
    values_to =  "stu_gender",
    values_drop_na = TRUE
  ) %>% 
  pivot_longer(
    cols = c("Q4_1":"Q4_19"),
    names_to = "toss1",
    values_to = "live_with",
    values_drop_na = TRUE
  ) %>% 
  pivot_longer(
    cols = c("Q16_1":"Q16_15","Q16_16"),
    names_to = "toss2",
    values_to = "ethnicity",
    values_drop_na = TRUE
  ) %>% 
  dplyr::select(c("id", "Q1", "Q2",
           "stu_gender", "live_with", "ethnicity",
           "Q9":"Q15",
           "Q17":"Q28",
           "Q46":"Q51B", 
           "Q52A", "Q52B", "Q52D",
           "Q53A", "Q53B", "Q53D",
           "Q54A", "Q54B", "Q54D",
           "Q55A", "Q56A", "Q57A",
           "Q58": "Q61",
           "Q106":"Q108",
           "Q162":"Q163_13",
           "SATOT":"PACFPERP"
  ))
  

ods <- long %>%
  mutate(district = factor(Q1),
         district = dplyr::recode(district,
                                'Siuslaw High School' = "Siuslaw",
                                'McKenzie High School' = "McKenzie",
                                'South Eugene High School' = "4J",
                                'Oakridge High School' = "Oakridge",
                                'Willamette High School' = "Bethel",
                                'Early College & Career Options (ECCO)' = "4J"),
         stu_gender = as.factor(stu_gender))

p <- ods %>% 
  select(Q162, district, PATOTR, SATOT, stu_gender) %>% 
  # filter(Q162 == "Yes" |
  #          Q162 == "No") %>% 
  mutate(total_abuse = PATOTR + SATOT) %>% 
  rename("Physical Abuse" = "PATOTR",
         "Sexual Abuse" = "SATOT" ) %>% 
  pivot_longer(
    cols = c("Physical Abuse", "Sexual Abuse"),
    names_to = "type_ab",
    values_to = "ab_scores"
) %>% 
  mutate(type_ab = as.factor(type_ab))

p <- p %>% 
  mutate(stu_gender = fct_recode(stu_gender,
             "Male"= '1',
             "Female" = '2',
             "Non-binary" = '3',
             "Non-binary" = '4',
             "Non-binary" ='5',
             "Non-binary" = '8',
              "NA" = '9')) %>% 
  rename(Gender = stu_gender)

p <- p %>% 
  group_by(type_ab, Gender, district) %>% 
  mutate(mean_ab = mean(total_abuse)) %>% 
  ungroup() 

```


Data Description {.sidebar}
===========
The plots displayed on this dashboard are generated from a synthetic dataset intended to represent original data from the *Oregon Child Abuse Prevalence Study*.



[Daniel Anderson](https://github.com/datalorax) produced this synthetic data using the [synthpop](https://cran.r-project.org/web/packages/synthpop/vignettes/synthpop.pdf) package.



[Akhila Nekkanti](https://github.com/akhilanekkanti1) created the plots shown using the [ggplot](https://ggplot2.tidyverse.org/reference/ggplot.html) package.

**To get a better picture of how abuse and neglect rates in Lane County look, the OCAP study directly asks high school students about their current and previous abuse and harrassment experiences.**


# Plot 1
More text to inlcude before the plots and things.

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Version 1

```{r plot1.1}

ggplot(p, aes(as.factor(type_ab), ab_scores)) +
	geom_violin(aes(fill=Gender)) +
  facet_wrap(~district) +
  labs(
    title = "Abuse Rates Across Districts"
  )

```

### Version 2

```{r plot1.2}

p %>% 
  filter(Gender == "Male" |
         Gender == "Female" |
           Gender == "Non-binary") %>% 
ggplot(aes(fct_reorder(district, mean_ab), mean_ab)) +
  geom_col(aes(fill = Gender), size = 5, position = position_dodge()) +
  facet_wrap(~type_ab, ncol = 1) +
  scale_color_brewer(palette = "Dark2") +
  coord_flip() +
  labs(
      title = "Average Abuse Scores",
  subtitle = "Results displayed by district, gender, and abuse type",
  x = "",
  y = "Average Score") +
  theme_minimal()

```


Column 
-----------------------------------------------------------------------

### Final Version

Little baby description about a little baby plot.

```{r plot 1.3}


p %>% 
  filter(Gender == "Male" |
         Gender == "Female" |
           Gender == "Non-binary") %>% 
ggplot(aes(as.factor(district), mean_ab)) +
	geom_line(color = "gray70", size = 2) +
  geom_point(aes(color = Gender), size = 5) +
  facet_wrap(~type_ab, ncol = 1) +
  scale_color_brewer(palette = "Dark2") +
  coord_flip() +
  labs(
      title = "Average Abuse Scores",
  subtitle = "Results displayed by district, gender, and abuse type",
  x = "",
  y = "Average Score") +
  theme_minimal()

```


# mtcars

Column {data-width=350}
-----------------------------------------------------------------------

### Chart A

```{r plot11}

ggplot(mpg, aes(displ, cty)) +
  geom_point(color = "orange") +
  geom_smooth() +
  facet_wrap(~class, ncol = 3) +
  labs(title = "Classic Plot w. Class But Different")



```


Column {data-width=650}
-----------------------------------------------------------------------

### Chart B

```{r}

p <- ggplot(mpg, aes(displ, cty)) +
  geom_point(color = "cornflowerblue") +
  geom_smooth() +
  facet_wrap(~class) +
  labs(title = "Classic Plot w. Class")

ggplotly(p)


```

### Chart C

```{r plot31, fig.height = 2}

ggplot(mpg, aes(displ, cty)) +
  geom_point(color = "magenta") +
  geom_smooth() +
  labs(title = "Classic Plot")

```

# reactable